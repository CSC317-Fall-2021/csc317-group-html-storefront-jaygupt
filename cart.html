<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/style.css">
    <title>Cart</title>
</head>

<body>
    <!--Navbar Start-->
    <header>
        <nav class="navbar">
            <h1 id="logo"><a href="index.html" id="logo-text"><span class="logo-g">G</span>ood<span
                        class="logo-g">G</span>ame</a></h1>
            <a href="index.html">HOME</a>
            <a href="categories.html">CATEGORIES</a>
            <input type="text" placeholder="Search products..." id="productSearch">
            <a href="login.html">LOGIN/REGISTER</a>
            <a href="#" class="current">CART</a>
            <a href="about_us.html">ABOUT</a>
        </nav>
    </header>
    <!--Navbar End-->

    <div class="title">Cart</div>
    <div id="cart">
        <div id="cartItems">
            <div class="cart-column"></div>
            <div id="productColumn" class="cart-column">Product</div>
            <div id="priceColumn" class="cart-column">Price</div>
            <div id="quantityColumn" class="cart-column">Quantity</div>
            <div id="subtotalColumn" class="cart-column">Subtotal</div>
        </div>
        <div id="bottomPart">
            <div id="enterCoupon">
                <label for="coupon">Have a Coupon?</label>
                <div class="coupon-input">
                    <input type="text" id="coupon" name="coupon" placeholder="Coupon Code">
                    <button class="btn apply-coupon">Apply</button>
                </div>
            </div>
            <div id="priceSummary">
                <div class="subtotal">Subtotal:</div>
                <div class="subtotal-amount amount"></div>
                <div class="discount">Discount:</div>
                <div class="discount-amount amount">-$9.00</div>
                <div class="tax">Tax:</div>
                <div class="tax-amount amount"></div>
                <div class="delivery">Delivery:</div>
                <div class="delivery-amount amount">$5.00</div>
                <div class="divider"></div>
                <div class="total">Total:</div>
                <div class="total-amount amount"></div>
                <a id="checkoutButton" href="shipping_information.html">
                    <button class="btn">Checkout</button>
                </a>
            </div>
        </div>
    </div>

    <footer class="footer">
        <p>GoodGame.com, Copyright &copy;2021</p>
    </footer>

    <!-- Script Tags -->
    <script type="text/javascript" src="js/main.js"></script>
    <script type="text/javascript" defer>
        // get the cart variable from local storage as an array
        let cart = JSON.parse(localStorage.getItem("cart")) || [];
        const cartItemsDivElement = document.getElementById("cartItems");

        // get the quantities variable from local storage as an array
        let quantities = JSON.parse(localStorage.getItem("quantities")) || [];

        // display all items added to cart
        for (var i = 0; i < cart.length; i++) {
            // create the cart items
            const quantity = quantities[i]; // find corresponding quantity of product
            const itemName = cart[i];
            const productInformation = findProduct(itemName);
            const itemPrice = productInformation["price"];
            const itemDescription = productInformation["description"];
            const itemImageSrc = productInformation["imageSrc"];
            const itemPageURL = productInformation["pageURL"];
            const itemCategory = productInformation["category"];
            const correspondingCategoryFolder = categoryToFolder[itemCategory];
            const linkToProductPage = `product_pages/${correspondingCategoryFolder}/${itemPageURL}`;

            const itemPictureDivElement = document.createElement("div");
            cartItemsDivElement.appendChild(itemPictureDivElement);
            itemPictureDivElement.className = "item-picture";

            const itemImageAElement = document.createElement("a");
            itemPictureDivElement.appendChild(itemImageAElement);
            itemImageAElement.setAttribute("href", linkToProductPage);

            const itemImageElement = document.createElement("img");
            itemImageAElement.appendChild(itemImageElement);
            itemImageElement.setAttribute("src", itemImageSrc);
            itemImageElement.setAttribute("alt", itemName);

            const itemInformationDivElement = document.createElement("div");
            itemInformationDivElement.className = "item-information";
            cartItemsDivElement.appendChild(itemInformationDivElement);

            const itemHeaderElement = document.createElement("h1");
            itemHeaderElement.textContent = itemName;
            itemInformationDivElement.appendChild(itemHeaderElement);

            const itemDescriptionElement = document.createElement("p");
            itemInformationDivElement.appendChild(itemDescriptionElement);

            // display first 50 characters from description
            itemDescriptionElement.textContent = itemDescription.substring(0, 100) + "...";

            // add "Read More" clickable link to description
            const readMoreAElement = document.createElement("a");
            readMoreAElement.setAttribute("href", linkToProductPage);
            readMoreAElement.textContent = "Read More";
            itemDescriptionElement.appendChild(readMoreAElement);

            const itemPriceDivElement = document.createElement("div");
            cartItemsDivElement.appendChild(itemPriceDivElement);
            itemPriceDivElement.classList.add("item-price", "item-price-" + i)

            const itemPricePElement = document.createElement("p");
            itemPriceDivElement.appendChild(itemPricePElement);
            itemPricePElement.textContent = "$" + itemPrice;

            const itemQuantityDivElement = document.createElement("div");
            itemQuantityDivElement.className = "item-quantity";
            cartItemsDivElement.appendChild(itemQuantityDivElement);

            const itemQuantityLabelElement = document.createElement("label");
            itemQuantityDivElement.appendChild(itemQuantityLabelElement);
            itemQuantityLabelElement.setAttribute("for", "quantity");

            const itemQuantitySelectElement = document.createElement("select");
            itemQuantitySelectElement.className = "quantity-select";
            itemQuantityDivElement.appendChild(itemQuantitySelectElement);
            itemQuantityLabelElement.setAttribute("name", "quantity");
            itemQuantityLabelElement.setAttribute("id", "quantity");
            for (var j = 1; j < 11; j++) {
                const quantityOptionElement = document.createElement("option");
                itemQuantitySelectElement.appendChild(quantityOptionElement);
                quantityOptionElement.setAttribute("value", j);
                quantityOptionElement.textContent = j;
            }

            // set the value of the select element using quantities array from localStorage
            itemQuantitySelectElement.value = quantity;

            const itemSubtotalDivElement = document.createElement("div");
            cartItemsDivElement.appendChild(itemSubtotalDivElement);
            itemSubtotalDivElement.className = "item-subtotal";
            const itemSubtotalPElement = document.createElement("p");
            itemSubtotalDivElement.appendChild(itemSubtotalPElement);
            itemSubtotalPElement.className = "subtotal-" + i;
            const itemSubtotalPElementInitialValue = itemPrice * quantity;
            itemSubtotalPElement.textContent = "$" + itemSubtotalPElementInitialValue.toFixed(2);
            const removeFromCartButton = document.createElement("button");
            itemSubtotalDivElement.appendChild(removeFromCartButton);
            removeFromCartButton.classList.add("btn", "remove-button");
            removeFromCartButton.setAttribute("itemkey", i);
            removeFromCartButton.textContent = "Remove from Cart";
        }

        // using querySelectorAll in order to add an event listener to each remove button
        const removeFromCartButtons = cartItemsDivElement.querySelectorAll(".remove-button");
        removeFromCartButtons.forEach(btn => {
            btn.addEventListener('click', function () {
                console.log(btn);
                var itemKey = btn.getAttribute("itemkey");

                // remove the element from the cart array
                cart.splice(itemKey, 1);

                // reset the value of cart in local storage
                localStorage.setItem("cart", JSON.stringify(cart));

                location.reload();
            });
        });
    </script>
    <script type="text/javascript" defer>
        const quantitySelectElements = document.querySelectorAll(".quantity-select");
        const subtotalSummaryElement = document.getElementsByClassName("subtotal-amount amount")[0];
        const taxSummaryElement = document.getElementsByClassName("tax-amount amount")[0];
        const totalSummaryElement = document.getElementsByClassName("total-amount amount")[0];

        // calculate subtotal, tax, & total based on what is in the cart initially
        const rowSubtotalElements = document.querySelectorAll(".item-subtotal p"); // getting all the subtotal row elements
        var summarySubtotalValue = 0;
        var totalSummaryValue = 0;
        for (let i = 0; i < rowSubtotalElements.length; i++) {
            summarySubtotalValue += parseFloat(rowSubtotalElements[i].textContent.slice(1));
        }
        taxSummaryValue = summarySubtotalValue * 0.0725; // tax is 7.25% of subtotal 
        totalSummaryValue = summarySubtotalValue + taxSummaryValue;
        subtotalSummaryElement.textContent = "$" + summarySubtotalValue.toFixed(2); // set summary subtotal value
        taxSummaryElement.textContent = "$" + taxSummaryValue.toFixed(2); // set summary tax value
        totalSummaryElement.textContent = "$" + (totalSummaryValue - 4).toFixed(2); // set summary total value

        // add event listener to every quantitySelect element; change subtotal when quantity changes, and store
        // the new value of quantity in localStorage
        for (let i = 0; i < quantitySelectElements.length; i++) {
            quantitySelectElements[i].addEventListener("change", (event) => {
                const valueChangedTo = event.target.value;

                // set the corresponding value in quantities from localStorage
                quantities[i] = parseInt(valueChangedTo);
                localStorage.setItem("quantities", JSON.stringify(quantities));

                // get the price per unit of that row
                const correspondingPricePerUnit = document.getElementsByClassName("item-price-" + i)[0].textContent.slice(1);
                
                // get the corresponding subtotal element of that row, to replace its value (2 decimal places)
                const correspondingSubtotalPElement = document.getElementsByClassName("subtotal-" + i)[0];

                const correspondingSubtotalPElementValue = correspondingSubtotalPElement.textContent.slice(1);
                const newCorrespondingSubtotalPElementValue = correspondingPricePerUnit * valueChangedTo;
                correspondingSubtotalPElement.textContent = "$" + newCorrespondingSubtotalPElementValue.toFixed(2);
                const subtotalSummaryElementOldValue = subtotalSummaryElement.textContent.slice(1);

                // New Summary Subtotal Value = Old Summary Subtotal Value - Old Corresponding Subtotal Value + New Corresponding Subtotal Value 
                const newSummarySubtotalValue = subtotalSummaryElementOldValue - correspondingSubtotalPElementValue + newCorrespondingSubtotalPElementValue;
                const newTaxPElementValue = newSummarySubtotalValue * 0.0725; // calculate new summary tax value
                const newTotalPElementValue = newSummarySubtotalValue + newTaxPElementValue; // calculate new summary total value
                
                subtotalSummaryElement.textContent = "$" + newSummarySubtotalValue.toFixed(2);
                taxSummaryElement.textContent = "$" + newTaxPElementValue.toFixed(2); // set the summary tax value
                totalSummaryElement.textContent = "$" + (newTotalPElementValue - 4).toFixed(2); // set the summary total value
            });
        }

        // if there are no items, hide the summary
        const itemPictureDivElements = document.getElementsByClassName("item-picture");
        const bottomPartDivElement = document.getElementById("bottomPart");
        if (itemPictureDivElements.length == 0) {
            bottomPartDivElement.style.visibility = "hidden";
        }
    </script>
</body>

</html>